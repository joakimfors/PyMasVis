import numpy as np
import scipy.signal as signal


def ap_coeffs(fc, fs):
    '''
    Discrete first order allpass
    https://ccrma.stanford.edu/realsimple/DelayVar/Phasing_First_Order_Allpass_Filters.html
    http://users.abo.fi/htoivone/courses/sbappl/asp_chapter1.pdf

    T = 1.0/fs
    w_b = 2*np.pi*fc
    p_d = (1 - np.tan(w_b*T/2)) / (1 + np.tan(w_b*T/2))
    b = [p_d, -1.0]
    a = [1.0, -p_d]
    '''
    if fc > fs / 2.0001:
        fc = fs / 2.0001
    rho_b = np.tan(np.pi * fc / fs)
    p_d = (1 - rho_b) / (1 + rho_b)
    b = [p_d, -1.0]
    a = [1.0, -p_d]
    return (b, a)


def kfilter_coeffs(fs):
    # Pre filter
    f0 = 1681.974450955533
    G = 3.999843853973347
    Q = 0.7071752369554196

    K = np.tan(np.pi * f0 / fs)
    Vh = 10.0 ** (G / 20.0)
    Vb = Vh**0.4996667741545416

    a0 = 1.0 + K / Q + K * K
    b0 = (Vh + Vb * K / Q + K * K) / a0
    b1 = 2.0 * (K * K - Vh) / a0
    b2 = (Vh - Vb * K / Q + K * K) / a0
    a1 = 2.0 * (K * K - 1.0) / a0
    a2 = (1.0 - K / Q + K * K) / a0

    b_pre = [b0, b1, b2]
    a_pre = [1.0, a1, a2]

    # Highpass filter
    f0 = 38.13547087602444
    Q = 0.5003270373238773
    K = np.tan(np.pi * f0 / fs)

    a1 = 2.0 * (K * K - 1.0) / (1.0 + K / Q + K * K)
    a2 = (1.0 - K / Q + K * K) / (1.0 + K / Q + K * K)

    b_hp = [1.0, -2.0, 1.0]
    a_hp = [1.0, a1, a2]

    b = signal.convolve(b_pre, b_hp)
    a = signal.convolve(a_pre, a_hp)
    return (b, a)


def fir_coeffs():
    return np.array(
        [
            [
                -0.001780280772489,
                0.003253283030257,
                -0.005447293390376,
                0.008414568116553,
                -0.012363296099675,
                0.017436805871070,
                -0.024020143876810,
                0.032746828420101,
                -0.045326602900760,
                0.066760686868173,
                -0.120643370377371,
                0.989429605248410,
                0.122160009958442,
                -0.046376232812786,
                0.022831393004364,
                -0.011580897261667,
                0.005358105753167,
                -0.001834671998839,
                -0.000103681038815,
                0.001002216283171,
                -0.001293611238062,
                0.001184842429930,
                -0.000908719377960,
                0.002061304229100,
            ],
            [
                -0.001473218555432,
                0.002925336766866,
                -0.005558126468508,
                0.009521159741206,
                -0.015296028027209,
                0.023398977482278,
                -0.034752051245281,
                0.050880967772373,
                -0.075227488678419,
                0.116949442543490,
                -0.212471239510148,
                0.788420616540440,
                0.460788819545818,
                -0.166082211358253,
                0.092555759769552,
                -0.057854829231334,
                0.037380809681132,
                -0.024098441541823,
                0.015115653825711,
                -0.009060645712669,
                0.005033299068467,
                -0.002511544062471,
                0.001030723665756,
                -0.000694079453823,
            ],
            [
                -0.000694079453823,
                0.001030723665756,
                -0.002511544062471,
                0.005033299068467,
                -0.009060645712669,
                0.015115653825711,
                -0.024098441541823,
                0.037380809681132,
                -0.057854829231334,
                0.092555759769552,
                -0.166082211358253,
                0.460788819545818,
                0.788420616540440,
                -0.212471239510148,
                0.116949442543490,
                -0.075227488678419,
                0.050880967772373,
                -0.034752051245281,
                0.023398977482278,
                -0.015296028027209,
                0.009521159741206,
                -0.005558126468508,
                0.002925336766866,
                -0.001473218555432,
            ],
            [
                0.002061304229100,
                -0.000908719377960,
                0.001184842429930,
                -0.001293611238062,
                0.001002216283171,
                -0.000103681038815,
                -0.001834671998839,
                0.005358105753167,
                -0.011580897261667,
                0.022831393004364,
                -0.046376232812786,
                0.122160009958442,
                0.989429605248410,
                -0.120643370377371,
                0.066760686868173,
                -0.045326602900760,
                0.032746828420101,
                -0.024020143876810,
                0.017436805871070,
                -0.012363296099675,
                0.008414568116553,
                -0.005447293390376,
                0.003253283030257,
                -0.001780280772489,
            ],
        ]
    )
